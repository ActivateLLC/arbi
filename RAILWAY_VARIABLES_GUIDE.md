# Railway Environment Variables Configuration Guide
## For Proper Database Persistence & Google Ads Integration

**Last Updated**: December 21, 2025
**Railway Project ID**: `3a3aebde-65aa-4d80-9496-4bb1e10321c1`

---

## üö® CRITICAL: Understanding Variable Sharing

Railway has **two types** of environment variables:

1. **Shared Variables** - Available to ALL services (set at project level)
2. **Service-Specific Variables** - Only available to ONE service

**The Problem**: If you set variables in the wrong place, services can't communicate!

---

## ‚úÖ CORRECT CONFIGURATION

### 1. PostgreSQL Service Variables (AUTO-GENERATED)

**These are automatically created by Railway's PostgreSQL service:**

```bash
# ‚úÖ SHARED (Railway generates these automatically)
DATABASE_URL=postgresql://postgres:password@postgres.railway.internal:5432/railway
PGHOST=postgres.railway.internal
PGPORT=5432
PGDATABASE=railway
PGUSER=postgres
PGPASSWORD=<auto-generated-password>
```

**IMPORTANT**:
- Railway PostgreSQL service automatically shares these with all services
- **DO NOT manually set these** - Railway manages them
- Use `PGHOST=postgres.railway.internal` for FREE private network (no egress fees)
- The API service will automatically detect and use these

---

### 2. API Service Variables (MUST BE SHARED)

**Set these at PROJECT LEVEL** so all services can access them:

#### Payment Processing (Required)
```bash
STRIPE_SECRET_KEY=sk_test_xxxxxxxxxxxxxxxxxxxx
STRIPE_PUBLISHABLE_KEY=pk_test_xxxxxxxxxxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxxxxxxxx
```

#### Google Ads API (Required for Real Ads)
```bash
GOOGLE_ADS_CLIENT_ID=123456789.apps.googleusercontent.com
GOOGLE_ADS_CLIENT_SECRET=GOCSPX-xxxxxxxxxxxxxxxxxxxx
GOOGLE_ADS_DEVELOPER_TOKEN=xxxxxxxxxxxxxxxxxxxx
GOOGLE_ADS_CUSTOMER_ID=1234567890
GOOGLE_ADS_REFRESH_TOKEN=1//xxxxxxxxxxxxxxxxxxxx
```

**CRITICAL GOOGLE ADS NOTES**:
- `GOOGLE_ADS_CUSTOMER_ID` must be **10 digits with NO DASHES**
  - ‚ùå Wrong: `123-456-7890`
  - ‚úÖ Right: `1234567890`
- Developer token must be approved (or use test account for instant approval)
- See `diagnose-google-ads.sh` for troubleshooting

#### Image Hosting (Required)
```bash
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=123456789012345
CLOUDINARY_API_SECRET=xxxxxxxxxxxxxxxxxxxx
```

#### Product Data API (Required)
```bash
RAINFOREST_API_KEY=xxxxxxxxxxxxxxxxxxxx
```

#### Application URLs (Required)
```bash
FRONTEND_URL=https://www.arbi.creai.dev
API_URL=https://api.arbi.creai.dev
```

---

### 3. Service-Specific Variables (API Service Only)

**Set these ONLY in the API service settings:**

```bash
NODE_ENV=production
PORT=3000
```

**Why service-specific?**
- PostgreSQL service doesn't need NODE_ENV or PORT
- These control only the API service behavior

---

## üîß HOW TO SET VARIABLES IN RAILWAY

### Method 1: Railway Dashboard (Recommended)

1. **For Shared Variables** (most variables):
   ```
   Railway Dashboard ‚Üí Your Project ‚Üí Variables Tab ‚Üí "New Variable"
   ‚Üí Select "Shared" ‚Üí Add variable
   ```

2. **For Service-Specific Variables** (NODE_ENV, PORT):
   ```
   Railway Dashboard ‚Üí Your Project ‚Üí API Service ‚Üí Variables Tab
   ‚Üí Add variable (will be service-specific by default)
   ```

### Method 2: Railway CLI (If Available)

```bash
# Set shared variable
railway variables set STRIPE_SECRET_KEY=sk_test_xxx --project

# Set service-specific variable
railway variables set NODE_ENV=production --service api
```

---

## üìä VARIABLE CHECKLIST

### PostgreSQL Service
- [ ] PostgreSQL service is created
- [ ] PostgreSQL service is using **private network** (postgres.railway.internal)
- [ ] DATABASE_URL is automatically shared with API service
- [ ] PGHOST, PGPORT, PGDATABASE, PGUSER, PGPASSWORD are set

### API Service - Shared Variables
- [ ] STRIPE_SECRET_KEY
- [ ] STRIPE_PUBLISHABLE_KEY
- [ ] STRIPE_WEBHOOK_SECRET
- [ ] GOOGLE_ADS_CLIENT_ID
- [ ] GOOGLE_ADS_CLIENT_SECRET
- [ ] GOOGLE_ADS_DEVELOPER_TOKEN
- [ ] GOOGLE_ADS_CUSTOMER_ID (10 digits, no dashes!)
- [ ] GOOGLE_ADS_REFRESH_TOKEN
- [ ] CLOUDINARY_CLOUD_NAME
- [ ] CLOUDINARY_API_KEY
- [ ] CLOUDINARY_API_SECRET
- [ ] RAINFOREST_API_KEY
- [ ] FRONTEND_URL
- [ ] API_URL

### API Service - Service-Specific
- [ ] NODE_ENV=production
- [ ] PORT=3000

---

## üö® TROUBLESHOOTING

### Issue: "Database save failed, using memory"

**Cause**: API service can't connect to PostgreSQL

**Check**:
```bash
# In Railway logs, look for:
"üóÑÔ∏è  Initializing database connection..."
"Host: postgres.railway.internal:5432"
"Database: railway"
"Network: PRIVATE (free)"
```

**Fix**:
1. Verify PostgreSQL service is running
2. Check that DATABASE_URL is set (should be automatic)
3. Ensure PGHOST=postgres.railway.internal (not public URL)
4. Restart API service after PostgreSQL is ready

### Issue: "Google Ads campaign creation failed"

**Cause**: Missing or incorrectly formatted Google Ads credentials

**Check**:
```bash
# Verify all 5 Google Ads variables are set
railway variables | grep GOOGLE_ADS
```

**Fix**:
1. Run `/home/user/arbi/diagnose-google-ads.sh` for detailed diagnostics
2. Verify CUSTOMER_ID has NO DASHES (must be 10 digits)
3. Check developer token is approved (or use test account)
4. Regenerate refresh token if needed

### Issue: "Cannot connect to database"

**Cause**: Using public URL instead of private network

**Check**:
```bash
# In Railway logs, look for:
"Network: PUBLIC (egress fees)"  # ‚ùå WRONG
"Network: PRIVATE (free)"        # ‚úÖ RIGHT
```

**Fix**:
1. Don't manually set DATABASE_URL
2. Let Railway's PostgreSQL service auto-share variables
3. Use PGHOST=postgres.railway.internal (not public URL)

---

## üí° BEST PRACTICES

### 1. Always Use Private Network
- **Private**: `postgres.railway.internal` (FREE)
- **Public**: `postgres-production-xxxx.railway.app` (COSTS MONEY)

### 2. Don't Duplicate Database Variables
- ‚ùå DON'T: Manually set DATABASE_URL
- ‚úÖ DO: Let PostgreSQL service auto-share it

### 3. Share API Credentials at Project Level
- All API keys (Stripe, Google Ads, Cloudinary) should be **shared**
- This allows future services (dashboard, cron jobs) to access them

### 4. Test After Every Change
```bash
# After updating variables, verify:
curl https://api.arbi.creai.dev/api/marketplace/listings | jq '.total'

# Should return: 18 (not 0)
```

---

## üéØ VERIFICATION STEPS

After configuring variables, verify everything works:

### 1. Database Persistence Test
```bash
# Create a product
curl -X POST https://api.arbi.creai.dev/api/marketplace/list \
  -H 'Content-Type: application/json' \
  -d '{
    "opportunityId": "test-persist-123",
    "productTitle": "Test Persistence Product",
    "productDescription": "Testing database persistence",
    "supplierPrice": 100,
    "supplierUrl": "https://amazon.com/test",
    "supplierPlatform": "amazon"
  }'

# Wait 10 seconds, then check if it's still there
sleep 10
curl https://api.arbi.creai.dev/api/marketplace/listings | jq '.total'

# Should show 19 products (18 original + 1 test)
```

### 2. Google Ads Test
```bash
# Check Railway logs for:
"üöÄ Creating real Google Ads campaign..."
"‚úÖ Budget created: customers/1234567890/campaignBudgets/xxx"
"‚úÖ Campaign created: customers/1234567890/campaigns/xxx"
"‚úÖ Ad Group created: customers/1234567890/adGroups/xxx"
"‚úÖ Ad created: customers/1234567890/adGroupAds/xxx"
"üéØ Campaign LIVE: ..."

# If you see errors, run:
bash /home/user/arbi/diagnose-google-ads.sh
```

### 3. Product Page Test
```bash
# Pick any product URL and verify it loads:
curl -I https://api.arbi.creai.dev/product/listing_1766305134577_9diz3d474

# Should return: HTTP/1.1 200 OK
```

---

## üìã QUICK REFERENCE

### What Goes Where?

| Variable | Location | Why |
|----------|----------|-----|
| DATABASE_URL | Auto-shared by PostgreSQL | Railway manages it |
| PGHOST, PGPORT, etc. | Auto-shared by PostgreSQL | Railway manages it |
| STRIPE_* | Shared (project level) | API service needs it |
| GOOGLE_ADS_* | Shared (project level) | API service needs it |
| CLOUDINARY_* | Shared (project level) | API service needs it |
| RAINFOREST_API_KEY | Shared (project level) | API service needs it |
| FRONTEND_URL | Shared (project level) | CORS configuration |
| API_URL | Shared (project level) | Frontend needs it |
| NODE_ENV | Service-specific (API) | Only API needs it |
| PORT | Service-specific (API) | Only API needs it |

---

## üöÄ READY TO GO LIVE?

After configuring all variables:

1. **Rebuild API service** in Railway (to pick up new variables)
2. **Check logs** for database connection success
3. **Run product creation**:
   ```bash
   bash /home/user/arbi/create-all-listings.sh
   ```
4. **Verify all 18 products persist**:
   ```bash
   curl https://api.arbi.creai.dev/api/marketplace/listings | jq '.total'
   # Should return: 18
   ```
5. **Test a product listing** creates a real Google Ads campaign
6. **Share product links** and start making sales! üí∞

---

**Need Help?**
- Run `bash /home/user/arbi/diagnose-google-ads.sh` for Google Ads diagnostics
- Check Railway logs: `railway logs --service api | grep -E "(Database|Google Ads)"`
- See `FINAL_WORKING_STATUS.md` for system overview
- See `DASHBOARD_API_GUIDE.md` for API integration

**LET'S HIT THAT $10K!** üöÄ
